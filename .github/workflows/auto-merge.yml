name: Auto Review and Merge

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to auto-merge'
        required: true
        type: number

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-review:
    name: Auto Review PR
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if PR is from Copilot
        id: check_author
        run: |
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          if [[ "$PR_AUTHOR" == "copilot-swe-agent" ]] || [[ "$PR_AUTHOR" == "Copilot" ]]; then
            echo "trusted=true" >> $GITHUB_OUTPUT
          else
            echo "trusted=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate file structure
        run: |
          echo "Validating PR changes..."
          # Check that no .git directory changes
          if git diff --name-only origin/main...HEAD | grep -q "^\.git/"; then
            echo "Error: .git directory should not be modified"
            exit 1
          fi
          echo "‚úÖ File structure validation passed"

      - name: Check for security issues
        run: |
          echo "Checking for common security issues..."
          # Check for hardcoded credentials
          if git diff origin/main...HEAD | grep -iE "(password|api_key|secret|token)\s*=\s*['\"][^'\"]+['\"]"; then
            echo "‚ö†Ô∏è Warning: Potential hardcoded credentials detected"
          fi
          echo "‚úÖ Security check completed"

      - name: Approve PR from trusted source
        if: steps.check_author.outputs.trusted == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'APPROVE',
              body: '‚úÖ Auto-approved by GitHub Actions - PR from trusted source (Copilot)'
            });

      - name: Mark as ready for review if draft
        if: github.event.pull_request.draft == true && steps.check_author.outputs.trusted == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              draft: false
            });

  auto-merge:
    name: Auto Merge PR
    needs: auto-review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Enable auto-merge
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            
            // Check if PR is from trusted source
            const trustedAuthors = ['copilot-swe-agent', 'Copilot', context.repo.owner];
            const isTrusted = trustedAuthors.includes(pr.user.login);
            
            if (isTrusted) {
              try {
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number,
                  merge_method: 'merge',
                  commit_title: `Auto-merge: ${pr.title}`,
                  commit_message: `Automatically merged PR #${context.issue.number} from ${pr.user.login}`
                });
                console.log('‚úÖ PR successfully merged');
              } catch (error) {
                console.log('‚ùå Auto-merge failed:', error.message);
                // If merge fails, just enable auto-merge for when checks pass
                try {
                  await github.rest.pulls.enableAutoMerge({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: context.issue.number,
                    merge_method: 'merge'
                  });
                  console.log('‚úÖ Auto-merge enabled for when checks pass');
                } catch (enableError) {
                  console.log('‚ö†Ô∏è Could not enable auto-merge:', enableError.message);
                }
              }
            } else {
              console.log('‚è∏Ô∏è PR not from trusted source, skipping auto-merge');
            }

  notify:
    name: Notify Status
    needs: [auto-review, auto-merge]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const reviewResult = '${{ needs.auto-review.result }}';
            const mergeResult = '${{ needs.auto-merge.result }}';
            
            let message = '## ü§ñ Auto-Review & Merge Status\n\n';
            message += `- **Review**: ${reviewResult === 'success' ? '‚úÖ Passed' : '‚ùå Failed'}\n`;
            message += `- **Merge**: ${mergeResult === 'success' ? '‚úÖ Completed' : '‚è∏Ô∏è Pending/Skipped'}\n`;
            
            if (mergeResult === 'success') {
              message += '\nüéâ This PR has been automatically merged!';
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
